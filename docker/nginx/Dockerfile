# =============================================================================
# SPIRE 26 - NGINX on Oracle Linux 9
# =============================================================================
FROM oraclelinux:9-slim

LABEL maintainer="SPIRE Development Team"
LABEL description="NGINX on Oracle Linux 9 for SPIRE 26"

# -----------------------------------------------------------------------------
# Install NGINX
# -----------------------------------------------------------------------------
RUN microdnf install -y \
    nginx \
    openssl \
    && microdnf clean all

# -----------------------------------------------------------------------------
# Create www-data user (consistent with php-fpm)
# -----------------------------------------------------------------------------
RUN groupadd -g 1000 www-data 2>/dev/null || true \
    && useradd -u 1000 -g www-data -m -s /bin/bash www-data 2>/dev/null || true

# -----------------------------------------------------------------------------
# Configure NGINX to run as www-data
# -----------------------------------------------------------------------------
RUN sed -i 's/user nginx;/user www-data;/' /etc/nginx/nginx.conf

# -----------------------------------------------------------------------------
# Create directories
# -----------------------------------------------------------------------------
RUN mkdir -p /var/cache/nginx \
    && mkdir -p /var/log/nginx \
    && mkdir -p /etc/nginx/certs \
    && chown -R www-data:www-data /var/cache/nginx \
    && chown -R www-data:www-data /var/log/nginx

# -----------------------------------------------------------------------------
# Working directory
# -----------------------------------------------------------------------------
WORKDIR /var/www/html

# -----------------------------------------------------------------------------
# Expose HTTP and HTTPS
# -----------------------------------------------------------------------------
EXPOSE 80 443

# -----------------------------------------------------------------------------
# Start NGINX
# -----------------------------------------------------------------------------
CMD ["nginx", "-g", "daemon off;"]
